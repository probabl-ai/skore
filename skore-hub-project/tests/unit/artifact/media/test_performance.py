from io import BytesIO

from matplotlib import pyplot as plt
from pydantic import ValidationError
from pytest import mark, param, raises

from skore_hub_project.artifact.media import (
    PrecisionRecallDataFrameTest,
    PrecisionRecallDataFrameTrain,
    PrecisionRecallSVGTest,
    PrecisionRecallSVGTrain,
    PredictionErrorDataFrameTest,
    PredictionErrorDataFrameTrain,
    PredictionErrorSVGTest,
    PredictionErrorSVGTrain,
    RocDataFrameTest,
    RocDataFrameTrain,
    RocSVGTest,
    RocSVGTrain,
)
from skore_hub_project.artifact.serializer import Serializer
from skore_hub_project.json import dumps


def serialize_svg(display) -> bytes:
    with BytesIO() as stream:
        display.plot()
        display.figure_.savefig(stream, format="svg", bbox_inches="tight")
        plt.close(display.figure_)

        figure_bytes = stream.getvalue()

    return figure_bytes


def serialize_dataframe(display) -> bytes:
    frame = display.frame()
    return dumps(
        frame.astype(object).where(frame.notna(), "NaN").to_dict(orient="tight")
    )


@mark.filterwarnings(
    # ignore deprecation warnings generated by the way `pandas` is used by `searborn`,
    # which is a dependency of `skore`
    "ignore:The default of observed=False is deprecated.*:FutureWarning:seaborn",
)
@mark.parametrize(
    "Media,report,accessor,data_source,content_type,serialize",
    (
        param(
            PrecisionRecallSVGTest,
            "binary_classification",
            "precision_recall",
            "test",
            "image/svg+xml",
            serialize_svg,
            id="PrecisionRecallSVGTest[estimator]",
        ),
        param(
            PrecisionRecallDataFrameTest,
            "binary_classification",
            "precision_recall",
            "test",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PrecisionRecallDataFrameTest[estimator]",
        ),
        param(
            PrecisionRecallSVGTrain,
            "binary_classification",
            "precision_recall",
            "train",
            "image/svg+xml",
            serialize_svg,
            id="PrecisionRecallSVGTrain[estimator]",
        ),
        param(
            PrecisionRecallDataFrameTrain,
            "binary_classification",
            "precision_recall",
            "train",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PrecisionRecallDataFrameTrain[estimator]",
        ),
        param(
            PrecisionRecallSVGTest,
            "cv_binary_classification",
            "precision_recall",
            "test",
            "image/svg+xml",
            serialize_svg,
            id="PrecisionRecallSVGTest[cross-validation]",
        ),
        param(
            PrecisionRecallDataFrameTest,
            "cv_binary_classification",
            "precision_recall",
            "test",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PrecisionRecallDataFrameTest[cross-validation]",
        ),
        param(
            PrecisionRecallSVGTrain,
            "cv_binary_classification",
            "precision_recall",
            "train",
            "image/svg+xml",
            serialize_svg,
            id="PrecisionRecallSVGTrain[cross-validation]",
        ),
        param(
            PrecisionRecallDataFrameTrain,
            "cv_binary_classification",
            "precision_recall",
            "train",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PrecisionRecallDataFrameTrain[cross-validation]",
        ),
        param(
            PredictionErrorSVGTest,
            "regression",
            "prediction_error",
            "test",
            "image/svg+xml",
            serialize_svg,
            id="PredictionErrorSVGTest[estimator]",
        ),
        param(
            PredictionErrorDataFrameTest,
            "regression",
            "prediction_error",
            "test",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PredictionErrorDataFrameTest[estimator]",
        ),
        param(
            PredictionErrorSVGTrain,
            "regression",
            "prediction_error",
            "train",
            "image/svg+xml",
            serialize_svg,
            id="PredictionErrorSVGTrain[estimator]",
        ),
        param(
            PredictionErrorDataFrameTrain,
            "regression",
            "prediction_error",
            "train",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PredictionErrorDataFrameTrain[estimator]",
        ),
        param(
            PredictionErrorSVGTest,
            "cv_regression",
            "prediction_error",
            "test",
            "image/svg+xml",
            serialize_svg,
            id="PredictionErrorSVGTest[cross-validation]",
        ),
        param(
            PredictionErrorDataFrameTest,
            "cv_regression",
            "prediction_error",
            "test",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PredictionErrorDataFrameTest[cross-validation]",
        ),
        param(
            PredictionErrorSVGTrain,
            "cv_regression",
            "prediction_error",
            "train",
            "image/svg+xml",
            serialize_svg,
            id="PredictionErrorSVGTrain[cross-validation]",
        ),
        param(
            PredictionErrorDataFrameTrain,
            "cv_regression",
            "prediction_error",
            "train",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="PredictionErrorDataFrameTrain[cross-validation]",
        ),
        param(
            RocSVGTest,
            "binary_classification",
            "roc",
            "test",
            "image/svg+xml",
            serialize_svg,
            id="RocSVGTest[estimator]",
        ),
        param(
            RocDataFrameTest,
            "binary_classification",
            "roc",
            "test",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="RocDataFrameTest[estimator]",
        ),
        param(
            RocSVGTrain,
            "binary_classification",
            "roc",
            "train",
            "image/svg+xml",
            serialize_svg,
            id="RocSVGTrain[estimator]",
        ),
        param(
            RocDataFrameTrain,
            "binary_classification",
            "roc",
            "train",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="RocDataFrameTrain[estimator]",
        ),
        param(
            RocSVGTest,
            "cv_binary_classification",
            "roc",
            "test",
            "image/svg+xml",
            serialize_svg,
            id="RocSVGTest[cross-validation]",
        ),
        param(
            RocDataFrameTest,
            "cv_binary_classification",
            "roc",
            "test",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="RocDataFrameTest[cross-validation]",
        ),
        param(
            RocSVGTrain,
            "cv_binary_classification",
            "roc",
            "train",
            "image/svg+xml",
            serialize_svg,
            id="RocSVGTrain[cross-validation]",
        ),
        param(
            RocDataFrameTrain,
            "cv_binary_classification",
            "roc",
            "train",
            "application/vnd.dataframe",
            serialize_dataframe,
            id="RocDataFrameTrain[cross-validation]",
        ),
    ),
)
@mark.respx()
def test_performance(
    monkeypatch,
    Media,
    report,
    accessor,
    data_source,
    content_type,
    serialize,
    upload_mock,
    request,
    project,
):
    report = request.getfixturevalue(report)
    display = getattr(report.metrics, accessor)(data_source=data_source)
    content = serialize(display)

    with Serializer(content) as serializer:
        checksum = serializer.checksum

    # available accessor
    assert Media(project=project, report=report).model_dump() == {
        "content_type": content_type,
        "name": accessor,
        "data_source": data_source,
        "checksum": checksum,
    }

    # ensure `upload` is well called
    assert upload_mock.called
    assert not upload_mock.call_args.args
    assert upload_mock.call_args.kwargs == {
        "project": project,
        "content": content,
        "content_type": content_type,
    }

    # unavailable accessor
    monkeypatch.delattr(report.metrics.__class__, accessor)
    upload_mock.reset_mock()

    assert Media(project=project, report=report).model_dump() == {
        "content_type": content_type,
        "name": accessor,
        "data_source": data_source,
        "checksum": None,
    }

    # ensure `upload` is not called
    assert not upload_mock.called

    # wrong type
    with raises(
        ValidationError,
        match=f"Input should be an instance of {report.__class__.__name__}",
    ):
        Media(project=project, report=None)
